# **README: Educational Exploit for Apache Struts2 RCE (CVE-2017-5638)**

## **Overview**

This project demonstrates an **educational exploit** for the **CVE-2017-5638 vulnerability** in Apache Struts2. The vulnerability allowed remote attackers to execute arbitrary commands on the server due to improper handling of user inputs in HTTP headers. This script provides insights into how the exploit worked and introduces a **novel payload delivery method** for bypassing basic security measures.

This project is intended for **educational purposes only** to help researchers, students, and professionals understand how vulnerabilities are exploited and, more importantly, how to defend against them.

---

## **What Will You Learn?**

1. **How the Vulnerability Works**:
   - Understand the root cause of the CVE-2017-5638 vulnerability.
   - Learn how OGNL (Object-Graph Navigation Language) expressions are exploited.

2. **Exploitation Techniques**:
   - Study a novel method of payload delivery using multipart POST requests with encoded commands.

3. **Defensive Strategies**:
   - Explore methods to secure applications, including patching, input validation, and disabling risky features.

4. **Practical Skills**:
   - Gain experience in understanding malicious payloads and analyzing server responses.

---

## **How the Exploit Works**

1. **The Vulnerability**:
   - Apache Struts2 fails to properly sanitize inputs in the `Content-Type` HTTP header or multipart POST requests.
   - OGNL expressions in user inputs are evaluated, allowing command execution on the server.

2. **The Exploit**:
   - The script injects a Base64-encoded payload into a multipart POST request.
   - The server decodes and executes the payload, returning the command’s output to the attacker.

3. **Novel Technique**:
   - Instead of exploiting the `Content-Type` header directly (common in older exploits), the script hides the payload within multipart form data, making it harder to detect.

---

## **How to Use**

### **1. Prerequisites**
- A vulnerable instance of Apache Struts2 with CVE-2017-5638 (for educational testing).
- A Linux system with Zsh installed.
- Basic understanding of shell scripting and networking.

### **2. Save the Script**
- Save the script as `apache_struts2_exploit.zsh`.

### **3. Make It Executable**
```bash
chmod +x apache_struts2_exploit.zsh
```

### **4. Run the Script**
```bash
./apache_struts2_exploit.zsh
```

---

## **Sample Outputs**

### **Crafting Exploit Request**:
```
Crafting exploit request...
Exploit request crafted successfully.
```

### **Sending Exploit Request**:
```
Sending exploit request to http://vulnerable-app.com/upload...
Response saved to response.html. Check if the payload executed successfully.
```

### **Response File (response.html)**:
If successful, the server’s response might contain the result of the executed command:
```
root
```

---

## **Educational Breakdown of the Payload**

### **1. OGNL Manipulation**
- **What It Does**:
  - Grants full access to internal methods using OGNL, bypassing security checks.
- **Why It’s Dangerous**:
  - Attackers can invoke sensitive server-side methods and execute arbitrary commands.

### **2. Payload Encoding**
- **What It Does**:
  - Encodes the payload (`whoami`) in Base64 to bypass input validation filters.
- **Why It’s Effective**:
  - Many security tools fail to decode and inspect Base64-encoded inputs.

### **3. Command Execution**
- **What It Does**:
  - Executes the decoded payload on the server using `Runtime.getRuntime().exec()`.
- **Why It’s Powerful**:
  - Provides direct access to the server’s operating system, allowing attackers to run any command.

---

## **Defensive Strategies**

### **1. Patching**
- **What to Do**:
  - Upgrade Apache Struts2 to the latest version to eliminate the vulnerability.
- **Why**:
  - Patches ensure known vulnerabilities are fixed and no longer exploitable.

### **2. Disable OGNL Evaluation**
- **What to Do**:
  - Disable dynamic OGNL evaluation unless absolutely necessary.
- **Why**:
  - Reduces the attack surface by preventing untrusted OGNL expressions from being evaluated.

### **3. Input Validation**
- **What to Do**:
  - Sanitize and validate all user inputs, including headers and form data.
- **Why**:
  - Ensures malicious payloads are not processed by the server.

### **4. Use a Web Application Firewall (WAF)**
- **What to Do**:
  - Deploy a WAF to block requests containing OGNL expressions or encoded payloads.
- **Why**:
  - Provides an additional layer of defense against exploitation attempts.

### **5. Principle of Least Privilege**
- **What to Do**:
  - Run the server with the least privileges necessary for its operation.
- **Why**:
  - Limits the impact of a successful exploit.

---

## **Educational Use Cases**

1. **Vulnerability Analysis**:
   - Learn how attackers exploit command injection vulnerabilities.
   - Understand how security tools detect (or fail to detect) malicious payloads.

2. **Incident Response Training**:
   - Simulate a real-world attack to practice detecting and mitigating it.

3. **Security Awareness**:
   - Use the exploit to demonstrate the importance of patching and input validation.

---

## **Legal and Ethical Considerations**

1. **Authorized Use Only**:
   - This script must only be used on systems you own or have explicit permission to test.
   - Unauthorized use is illegal and unethical.

2. **Educational Focus**:
   - The purpose of this project is to educate about vulnerabilities and their defenses, not to cause harm.

3. **Share Knowledge Responsibly**:
   - Use this knowledge to secure systems and teach others how to prevent exploitation.

---

## **Conclusion**

This project provides an in-depth look at how an old vulnerability (**CVE-2017-5638**) can be exploited using modern techniques. By understanding the mechanics of the exploit, you can better defend against similar attacks and strengthen your cybersecurity skills. Always use this knowledge ethically to enhance security and protect systems from harm.